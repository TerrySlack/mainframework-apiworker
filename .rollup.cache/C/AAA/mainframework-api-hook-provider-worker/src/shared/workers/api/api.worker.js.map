{"version":3,"file":"api.worker.js","sourceRoot":"","sources":["api.worker.ts"],"names":[],"mappings":"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","sourcesContent":["/// <reference lib=\"webworker\" />\r\n\r\nimport type {\r\n  AbortControllers,\r\n  BinaryParseResult,\r\n  BinaryResponseMeta,\r\n  DataRequest,\r\n  StackArray,\r\n  WorkerApiRequest,\r\n  WorkerErrorKind,\r\n} from \"../../types/types\";\r\n\r\nexport const BINARY_MARKER = Symbol.for(\"WorkerApiBinary\");\r\n\r\nconst CODE_CACHE_MISS = \"CACHE_MISS\";\r\nconst CODE_INVALID_REQUEST = \"INVALID_REQUEST\";\r\nconst CODE_NETWORK_ERROR = \"NETWORK_ERROR\";\r\nconst CODE_UNKNOWN = \"UNKNOWN\";\r\nconst DEFAULT_FILES_FIELD = \"Files\";\r\n\r\nconst callerResponse = <T>(cacheName: string, data: T, hookId?: string | null, httpStatus?: number): void => {\r\n  self.postMessage({ cacheName, data: data ?? null, hookId, httpStatus });\r\n};\r\n\r\nconst makeError = (\r\n  kind: WorkerErrorKind,\r\n  message: string,\r\n  opts?: { status?: number; code?: string },\r\n): { kind: WorkerErrorKind; message: string; status?: number; code?: string } => ({\r\n  kind,\r\n  message,\r\n  ...opts,\r\n});\r\n\r\n/**\r\n * Binary response - transferred via postMessage, not stored in cache.\r\n * Client receives ArrayBuffer + meta for reconstruction (e.g. new Blob([data], { type })).\r\n */\r\nconst callerResponseBinary = (\r\n  cacheName: string,\r\n  data: ArrayBuffer,\r\n  meta: BinaryResponseMeta,\r\n  hookId?: string | null,\r\n  httpStatus?: number,\r\n): void => {\r\n  if (data) {\r\n    self.postMessage({ cacheName, data, meta, hookId, httpStatus }, [data]);\r\n  }\r\n};\r\n\r\nconst store = Object.create(null) as Record<string, unknown>;\r\nconst normalizeKey = (key: string) => key.toLocaleLowerCase();\r\nconst get = <TData>(key: string): TData | undefined => store[normalizeKey(key)] as TData | undefined;\r\nconst set = <TData>(key: string, value: TData): void => {\r\n  store[normalizeKey(key)] = value;\r\n};\r\nconst remove = (key: string): void => {\r\n  delete store[normalizeKey(key)];\r\n};\r\n\r\nconst isNonEmptyString = (v: unknown): v is string => typeof v === \"string\" && v.trim() !== \"\";\r\n\r\n/** Returns headers without Content-Type (either casing). Use when FormData sets it automatically. */\r\nconst omitContentType = (headers: Record<string, string>): Record<string, string> => {\r\n  const rest = { ...headers };\r\n  delete rest[\"Content-Type\"];\r\n  delete rest[\"content-type\"];\r\n  return rest;\r\n};\r\n\r\nconst isBinaryResponse = (r: unknown): r is BinaryParseResult =>\r\n  !!r &&\r\n  typeof r === \"object\" &&\r\n  BINARY_MARKER in r &&\r\n  (r as Record<symbol, unknown>)[BINARY_MARKER] === true &&\r\n  (r as unknown as BinaryParseResult).data instanceof ArrayBuffer;\r\n\r\nconst commit = <TData>(cacheName: string, data: TData, hookId?: string | null, httpStatus?: number): void => {\r\n  if (cacheName) {\r\n    set(normalizeKey(cacheName), data);\r\n    callerResponse(cacheName, data, hookId, httpStatus);\r\n    return;\r\n  }\r\n\r\n  callerResponse(\"error\", makeError(\"validation\", \"Invalid commit: cacheName is required\", { code: CODE_INVALID_REQUEST }), hookId);\r\n};\r\n\r\n/**\r\n * Parses response based on content-type.\r\n * Returns parsed data for JSON/text, or binary result with BINARY_MARKER, data (ArrayBuffer), contentType, contentDisposition.\r\n */\r\nconst parseResponseByContentType = async (response: Response): Promise<unknown> => {\r\n  const contentType = response.headers.get(\"content-type\")?.toLocaleLowerCase() || \"\";\r\n  const contentLength = response.headers.get(\"content-length\");\r\n\r\n  // No content\r\n  if (response.status === 204 || contentLength === \"0\") {\r\n    return null;\r\n  }\r\n\r\n  // JSON types - let it throw if malformed\r\n  if (contentType.includes(\"json\")) {\r\n    return await response.json();\r\n  }\r\n\r\n  // Text-based types\r\n  if (\r\n    contentType.startsWith(\"text/\") ||\r\n    contentType.includes(\"xml\") ||\r\n    contentType.includes(\"javascript\") ||\r\n    contentType.includes(\"x-www-form-urlencoded\")\r\n  ) {\r\n    return await response.text();\r\n  }\r\n\r\n  // Binary types (known or fallback) - use arrayBuffer for zero-copy transfer to client\r\n  const arrayBuffer = await response.arrayBuffer();\r\n  return {\r\n    [BINARY_MARKER]: true as const,\r\n    data: arrayBuffer,\r\n    contentType,\r\n    contentDisposition: response.headers.get(\"content-disposition\"),\r\n  };\r\n};\r\n\r\nconst appendToFormData = (\r\n  formData: FormData,\r\n  key: string,\r\n  value: unknown,\r\n  fileFieldName: string = DEFAULT_FILES_FIELD,\r\n): void => {\r\n  if (value instanceof File) {\r\n    formData.append(fileFieldName, value, value.name);\r\n    return;\r\n  }\r\n\r\n  if (value instanceof Blob) {\r\n    formData.append(fileFieldName, value, \"blob\");\r\n    return;\r\n  }\r\n\r\n  if (value !== undefined && value !== null) {\r\n    if (typeof value === \"object\") {\r\n      formData.append(key, JSON.stringify(value));\r\n    } else {\r\n      const primitive = value as string | number | boolean | bigint | symbol;\r\n      formData.append(key, String(primitive));\r\n    }\r\n  }\r\n};\r\n\r\nconst pushObjectToStack = (\r\n  obj: Record<string, unknown>,\r\n  parentKey: string,\r\n  stack: Array<{ key: string; value: unknown }>,\r\n) => {\r\n  for (const k in obj) {\r\n    if (Object.prototype.hasOwnProperty.call(obj, k)) {\r\n      stack.push({\r\n        key: parentKey ? `${parentKey}.${k}` : k,\r\n        value: obj[k],\r\n      });\r\n    }\r\n  }\r\n};\r\n\r\nconst createFormDataIfBlobOrFile = (\r\n  payload: unknown,\r\n  fileFieldName: string = DEFAULT_FILES_FIELD,\r\n): FormData | null => {\r\n  if (payload === null || payload === undefined || typeof payload !== \"object\") {\r\n    return null;\r\n  }\r\n\r\n  const formData = new FormData();\r\n  let hasFile = false;\r\n  const visited = new WeakSet<object>();\r\n  const stack: StackArray[] = [];\r\n\r\n  visited.add(payload);\r\n  if (Array.isArray(payload)) {\r\n    let i = 0;\r\n    while (i < payload.length) {\r\n      stack.push({ key: String(i), value: payload[i] });\r\n      i++;\r\n    }\r\n  } else {\r\n    pushObjectToStack(payload as Record<string, unknown>, \"\", stack);\r\n  }\r\n\r\n  // Safe iteration - iterate forward, then clear\r\n  for (let i = 0; i < stack.length; i++) {\r\n    const entry = stack[i];\r\n    if (entry === undefined) continue;\r\n    const { key, value } = entry;\r\n\r\n    if (value instanceof File || value instanceof Blob) {\r\n      hasFile = true;\r\n      appendToFormData(formData, key, value, fileFieldName);\r\n      continue;\r\n    }\r\n\r\n    if (Array.isArray(value)) {\r\n      if (visited.has(value)) continue;\r\n      visited.add(value);\r\n      let j = 0;\r\n      while (j < value.length) {\r\n        stack.push({ key: `${key}.${j}`, value: value[j] });\r\n        j++;\r\n      }\r\n      continue;\r\n    }\r\n\r\n    if (value !== null && typeof value === \"object\") {\r\n      if (visited.has(value)) continue;\r\n      visited.add(value);\r\n      pushObjectToStack(value as Record<string, unknown>, key, stack);\r\n      continue;\r\n    }\r\n\r\n    appendToFormData(formData, key, value, fileFieldName);\r\n  }\r\n\r\n  return hasFile ? formData : null;\r\n};\r\n\r\nconst getContentType = (headers: Record<string, string> = {}): string =>\r\n  headers[\"Content-Type\"] || headers[\"content-type\"] || \"application/json\";\r\n\r\nconst getPayloadType = (payload: unknown): string => {\r\n  switch (true) {\r\n    case payload instanceof FormData:\r\n      return \"formdata\";\r\n    case payload instanceof Blob:\r\n      return \"blob\";\r\n    case payload instanceof ArrayBuffer:\r\n      return \"arraybuffer\";\r\n    case ArrayBuffer.isView(payload):\r\n      return \"arraybufferview\";\r\n    case typeof ReadableStream !== \"undefined\" && payload instanceof ReadableStream:\r\n      return \"stream\";\r\n    case typeof payload === \"string\":\r\n      return \"string\";\r\n    default:\r\n      return \"object\";\r\n  }\r\n};\r\n\r\nconst buildJsonBody = (payload: unknown): BodyInit => JSON.stringify(payload);\r\nconst buildUrlEncodedBody = (payload: Record<string, string>): BodyInit =>\r\n  new URLSearchParams(payload).toString();\r\nconst buildTextBody = (payload: unknown): BodyInit => String(payload);\r\n\r\nconst prepareRequestBody = (\r\n  payload: unknown,\r\n  headers: Record<string, string>,\r\n  options?: { formDataFileFieldName?: string },\r\n): { body?: BodyInit; headers: Record<string, string> } => {\r\n  const payloadType = getPayloadType(payload);\r\n  const outHeaders = (): Record<string, string> => ({ ...headers });\r\n\r\n  switch (payloadType) {\r\n    case \"formdata\":\r\n      return { body: payload as FormData, headers: omitContentType(outHeaders()) };\r\n\r\n    case \"blob\":\r\n      return { body: payload as Blob, headers: outHeaders() };\r\n\r\n    case \"arraybuffer\":\r\n      return { body: payload as ArrayBuffer, headers: outHeaders() };\r\n\r\n    case \"arraybufferview\":\r\n      return { body: payload as BodyInit, headers: outHeaders() };\r\n\r\n    case \"stream\":\r\n      return { body: payload as ReadableStream<Uint8Array>, headers: outHeaders() };\r\n\r\n    case \"string\":\r\n      return { body: payload as string, headers: outHeaders() };\r\n\r\n    case \"object\": {\r\n      const h = outHeaders();\r\n      const contentType = getContentType(h);\r\n      const fileFieldName = options?.formDataFileFieldName ?? DEFAULT_FILES_FIELD;\r\n\r\n      let body: BodyInit;\r\n      if (contentType.includes(\"application/json\")) {\r\n        body = buildJsonBody(payload);\r\n      } else if (contentType.includes(\"application/x-www-form-urlencoded\")) {\r\n        body = buildUrlEncodedBody(payload as Record<string, string>);\r\n      } else if (contentType.startsWith(\"text/\") || contentType.includes(\"xml\")) {\r\n        body = buildTextBody(payload);\r\n      } else if (contentType.includes(\"multipart/form-data\")) {\r\n        const formData = createFormDataIfBlobOrFile(payload, fileFieldName);\r\n        if (formData) {\r\n          return { body: formData, headers: omitContentType(h) };\r\n        }\r\n        body = buildJsonBody(payload);\r\n        h[\"Content-Type\"] = \"application/json\";\r\n      } else {\r\n        body = buildJsonBody(payload);\r\n      }\r\n\r\n      if (!h[\"Content-Type\"] && !h[\"content-type\"]) {\r\n        h[\"Content-Type\"] = contentType;\r\n      }\r\n      return { body, headers: h };\r\n    }\r\n\r\n    default:\r\n      return { headers: outHeaders() };\r\n  }\r\n};\r\n\r\nconst inFlightControllers: AbortControllers = new Map();\r\nconst inFlightByCacheName = new Map<string, Promise<void>>();\r\n\r\nconst apiRequest = async <TData>(\r\n  cacheName: string,\r\n  payload: TData | FormData | null,\r\n  {\r\n    url,\r\n    method,\r\n    headers = {},\r\n    mode = \"cors\",\r\n    credentials = \"same-origin\",\r\n    responseType,\r\n    timeoutMs,\r\n    formDataFileFieldName,\r\n  }: WorkerApiRequest,\r\n  requestId?: string | null,\r\n  hookId?: string | null,\r\n): Promise<void> => {\r\n  const methodLower = method.toLocaleLowerCase();\r\n  const responseTypeLower = responseType?.toLocaleLowerCase();\r\n\r\n  // Early return (cached then fresh) allowed for any HTTP method, except when response is binary or streaming.\r\n  const skipInFlightDedupe = responseTypeLower === \"binary\" || responseTypeLower === \"stream\";\r\n  if (!skipInFlightDedupe) {\r\n    const existing = inFlightByCacheName.get(cacheName);\r\n    if (existing) {\r\n      const cached = get(cacheName);\r\n      if (cached !== undefined) callerResponse(cacheName, cached, hookId);\r\n      await existing;\r\n      const fresh = get(cacheName);\r\n      if (fresh !== undefined) callerResponse(cacheName, fresh, hookId);\r\n      return;\r\n    }\r\n  }\r\n\r\n  const controller = new AbortController();\r\n  if (requestId) {\r\n    inFlightControllers.set(requestId, controller);\r\n  }\r\n\r\n  let timeoutId: ReturnType<typeof setTimeout> | undefined;\r\n  if (timeoutMs != null && timeoutMs > 0) {\r\n    timeoutId = setTimeout(() => controller.abort(), timeoutMs);\r\n  }\r\n\r\n  const promise = (async (): Promise<void> => {\r\n    const fetchOptions: RequestInit = {\r\n      method,\r\n      mode,\r\n      credentials,\r\n      signal: controller.signal,\r\n    };\r\n\r\n    if (methodLower !== \"get\" && payload != null) {\r\n      const { body, headers: processedHeaders } = prepareRequestBody(payload, headers, (\r\n        formDataFileFieldName != null && formDataFileFieldName !== \"\" ? { formDataFileFieldName } : undefined\r\n      ));\r\n      if (body !== undefined) fetchOptions.body = body;\r\n      fetchOptions.headers = processedHeaders;\r\n    } else {\r\n      fetchOptions.headers = omitContentType({ ...headers });\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(url, fetchOptions);\r\n\r\n      if (response.status >= 400) {\r\n        callerResponse(\r\n          cacheName,\r\n          makeError(\"http\", response.statusText, { status: response.status, code: String(response.status) }),\r\n          hookId,\r\n          response.status,\r\n        );\r\n        return;\r\n      }\r\n\r\n      if (response.status === 204) {\r\n        set(normalizeKey(cacheName), null);\r\n        callerResponse(cacheName, null, hookId, 204);\r\n        return;\r\n      }\r\n\r\n      const responseData = await parseResponseByContentType(response);\r\n\r\n      if (isBinaryResponse(responseData)) {\r\n        callerResponseBinary(\r\n          cacheName,\r\n          responseData.data,\r\n          {\r\n            contentType: responseData.contentType,\r\n            contentDisposition: responseData.contentDisposition ?? null,\r\n          },\r\n          hookId,\r\n          response.status,\r\n        );\r\n      } else {\r\n        commit(cacheName, responseData, hookId, response.status);\r\n      }\r\n    } catch (error) {\r\n      if ((error as Error).name === \"AbortError\") {\r\n        return;\r\n      }\r\n      const err = error as Error;\r\n      const code = err.name === \"TypeError\" ? CODE_NETWORK_ERROR : CODE_UNKNOWN;\r\n      callerResponse(cacheName, makeError(\"network\", err.message, { code }), hookId);\r\n    } finally {\r\n      if (timeoutId != null) clearTimeout(timeoutId);\r\n      if (requestId) {\r\n        inFlightControllers.delete(requestId);\r\n      }\r\n      inFlightByCacheName.delete(cacheName);\r\n    }\r\n  })();\r\n\r\n  inFlightByCacheName.set(cacheName, promise);\r\n  await promise;\r\n};\r\n\r\nconst onRequest = <TData>(dataRequest: DataRequest<TData>): void => {\r\n  const { cacheName, type, payload, request, requestId, hookId } = dataRequest;\r\n\r\n  if (!isNonEmptyString(type)) {\r\n    callerResponse(\"error\", makeError(\"validation\", \"Invalid request: type is required\", { code: CODE_INVALID_REQUEST }), hookId);\r\n    return;\r\n  }\r\n  const lowerType = normalizeKey(type);\r\n\r\n  if (lowerType === \"cancel\") {\r\n    if (requestId) onCancel(requestId);\r\n    return;\r\n  }\r\n\r\n  if (!isNonEmptyString(cacheName)) {\r\n    callerResponse(\"error\", makeError(\"validation\", \"Invalid request: cacheName is required\", { code: CODE_INVALID_REQUEST }), hookId);\r\n    return;\r\n  }\r\n  const lowerCacheName = normalizeKey(cacheName);\r\n\r\n  if (lowerType === \"get\") {\r\n    const requestedData = get(lowerCacheName);\r\n    if (requestedData === undefined) {\r\n      callerResponse(lowerCacheName, makeError(\"validation\", \"Cache miss\", { code: CODE_CACHE_MISS }), hookId);\r\n    } else {\r\n      callerResponse(lowerCacheName, requestedData, hookId);\r\n    }\r\n  } else if (lowerType === \"set\") {\r\n      if (!request) {\r\n      if (payload == null) {\r\n        callerResponse(\r\n          \"error\",\r\n          makeError(\"validation\", \"Invalid request: payload is required for set\", { code: CODE_INVALID_REQUEST }),\r\n          hookId,\r\n        );\r\n        return;\r\n      }\r\n      set(lowerCacheName, payload);\r\n    } else {\r\n      const methodLower = normalizeKey(request.method);\r\n      if (methodLower !== \"get\" && payload == null) {\r\n        callerResponse(\r\n          \"error\",\r\n          makeError(\"validation\", \"Invalid request: payload is required for non-GET API request\", {\r\n            code: CODE_INVALID_REQUEST,\r\n          }),\r\n          hookId,\r\n        );\r\n        return;\r\n      }\r\n      void apiRequest(lowerCacheName, payload ?? null, request, requestId, hookId);\r\n    }\r\n  } else if (lowerType === \"delete\") {\r\n    remove(lowerCacheName);\r\n    callerResponse(lowerCacheName, { deleted: true }, hookId);\r\n  }\r\n};\r\n\r\nconst onCancel = (requestId: string): void => {\r\n  const controller = inFlightControllers.get(requestId);\r\n  if (controller) {\r\n    controller.abort();\r\n    inFlightControllers.delete(requestId);\r\n  }\r\n};\r\n\r\ntype WorkerMessageData = { dataRequest?: DataRequest<unknown> };\r\n\r\n/**\r\n * Public API: handle incoming messages from the main thread.\r\n * Expects payload shape { dataRequest?: DataRequest }. Dispatches to get/set/delete/cancel.\r\n * Responses are sent via postMessage: { cacheName, data?, meta?, hookId?, httpStatus? }.\r\n * Errors are sent as data: { kind: \"http\"|\"network\"|\"validation\", message, status?, code? }.\r\n */\r\nexport function handleMessage(data: unknown): void {\r\n  if (data === null || typeof data !== \"object\") return;\r\n  const dataRequest = (data as WorkerMessageData).dataRequest;\r\n  if (dataRequest !== undefined) onRequest(dataRequest);\r\n}\r\n\r\nonmessage = (event: MessageEvent): void => {\r\n  handleMessage(event.data);\r\n};\r\n"]}