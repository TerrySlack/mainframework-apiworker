{"version":3,"file":"useApiWorker.test.js","sourceRoot":"","sources":["useApiWorker.test.ts"],"names":[],"mappings":"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","sourcesContent":["/// <reference types=\"jest\" />\r\nimport { act, renderHook, waitFor } from \"@testing-library/react\";\r\nimport { useApiWorker } from \"./useApiWorker\";\r\n\r\nconst HTTPBIN_GET = \"https://httpbin.org/get\";\r\nconst WAIT_MS = 15000;\r\n\r\njest.setTimeout(25000);\r\n\r\ndeclare global {\r\n  var __WORKER_TERMINATE__: (() => Promise<void>) | undefined;\r\n}\r\n\r\nafterAll(async () => {\r\n  await globalThis.__WORKER_TERMINATE__?.();\r\n});\r\n\r\ndescribe(\"useApiWorker\", () => {\r\n  describe(\"API shape\", () => {\r\n    it(\"returns data, meta, loading, error, refetch, deleteCache\", () => {\r\n      const cacheName = \"useApiWorker-shape-\" + Date.now();\r\n      const { result } = renderHook(() =>\r\n        useApiWorker({\r\n          cacheName,\r\n          request: { url: HTTPBIN_GET, method: \"GET\" },\r\n          runMode: \"manual\",\r\n        }),\r\n      );\r\n\r\n      expect(result.current).toHaveProperty(\"data\");\r\n      expect(result.current).toHaveProperty(\"meta\");\r\n      expect(result.current).toHaveProperty(\"loading\");\r\n      expect(result.current).toHaveProperty(\"error\");\r\n      expect(typeof result.current.refetch).toBe(\"function\");\r\n      expect(typeof result.current.deleteCache).toBe(\"function\");\r\n    });\r\n  });\r\n\r\n  describe(\"runMode auto\", () => {\r\n    it(\"with request sends on mount: loading true, refetch and deleteCache are functions\", () => {\r\n      const cacheName = \"useApiWorker-auto-\" + Date.now();\r\n      const { result } = renderHook(() =>\r\n        useApiWorker({\r\n          cacheName,\r\n          request: { url: HTTPBIN_GET, method: \"GET\" },\r\n          runMode: \"auto\",\r\n        }),\r\n      );\r\n\r\n      expect(result.current.loading).toBe(true);\r\n      expect(typeof result.current.refetch).toBe(\"function\");\r\n      expect(typeof result.current.deleteCache).toBe(\"function\");\r\n    });\r\n  });\r\n\r\n  describe(\"runMode once\", () => {\r\n    it(\"resolves once; refetch does not send again\", async () => {\r\n      const cacheName = \"useApiWorker-once-\" + Date.now();\r\n      const { result } = renderHook(() =>\r\n        useApiWorker({\r\n          cacheName,\r\n          request: { url: HTTPBIN_GET, method: \"GET\" },\r\n          runMode: \"once\",\r\n        }),\r\n      );\r\n\r\n      await waitFor(\r\n        () => {\r\n          expect(result.current.loading).toBe(false);\r\n        },\r\n        { timeout: WAIT_MS },\r\n      );\r\n      const firstData = result.current.data;\r\n\r\n      act(() => {\r\n        result.current.refetch();\r\n      });\r\n\r\n      await waitFor(\r\n        () => {\r\n          expect(result.current.loading).toBe(false);\r\n        },\r\n        { timeout: WAIT_MS },\r\n      );\r\n      expect(result.current.data).toBe(firstData);\r\n    });\r\n  });\r\n\r\n  describe(\"runMode manual\", () => {\r\n    it(\"does not auto-send; refetch sends and returns data\", async () => {\r\n      const cacheName = \"useApiWorker-manual-\" + Date.now();\r\n      const { result } = renderHook(() =>\r\n        useApiWorker({\r\n          cacheName,\r\n          request: { url: HTTPBIN_GET, method: \"GET\" },\r\n          runMode: \"manual\",\r\n        }),\r\n      );\r\n\r\n      expect(result.current.loading).toBe(false);\r\n      expect(result.current.data).toBeNull();\r\n\r\n      act(() => {\r\n        result.current.refetch();\r\n      });\r\n\r\n      await waitFor(\r\n        () => {\r\n          expect(result.current.loading).toBe(false);\r\n          expect(result.current.data).toBeDefined();\r\n        },\r\n        { timeout: WAIT_MS },\r\n      );\r\n      expect((result.current.data as { url?: string })?.url).toBe(HTTPBIN_GET);\r\n    });\r\n  });\r\n\r\n  describe(\"enabled false\", () => {\r\n    it(\"does not request; loading stays false and data null\", async () => {\r\n      const cacheName = \"useApiWorker-disabled-\" + Date.now();\r\n      const { result } = renderHook(() =>\r\n        useApiWorker({\r\n          cacheName,\r\n          request: { url: HTTPBIN_GET, method: \"GET\" },\r\n          runMode: \"auto\",\r\n          enabled: false,\r\n        }),\r\n      );\r\n\r\n      await waitFor(() => {\r\n        expect(result.current.loading).toBe(false);\r\n      });\r\n      expect(result.current.data).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe(\"get-only (no request config)\", () => {\r\n    it(\"refetch sends get; worker returns CACHE_MISS and hook exposes error\", async () => {\r\n      const cacheName = \"useApiWorker-get-only-\" + Date.now();\r\n      const { result } = renderHook(() =>\r\n        useApiWorker({\r\n          cacheName,\r\n          runMode: \"manual\",\r\n        }),\r\n      );\r\n\r\n      expect(result.current.loading).toBe(false);\r\n      act(() => {\r\n        result.current.refetch();\r\n      });\r\n      await waitFor(\r\n        () => {\r\n          expect(result.current.loading).toBe(false);\r\n        },\r\n        { timeout: WAIT_MS },\r\n      );\r\n      expect(result.current.error).not.toBeNull();\r\n      expect(result.current.error?.code).toBe(\"CACHE_MISS\");\r\n    });\r\n  });\r\n\r\n  describe(\"deleteCache\", () => {\r\n    it(\"clears cache; refetch after delete still works\", async () => {\r\n      const cacheName = \"useApiWorker-delete-\" + Date.now();\r\n      const { result } = renderHook(() =>\r\n        useApiWorker({\r\n          cacheName,\r\n          request: { url: HTTPBIN_GET, method: \"GET\" },\r\n          runMode: \"manual\",\r\n        }),\r\n      );\r\n\r\n      act(() => {\r\n        result.current.refetch();\r\n      });\r\n      await waitFor(\r\n        () => {\r\n          expect(result.current.data).toBeDefined();\r\n        },\r\n        { timeout: WAIT_MS },\r\n      );\r\n\r\n      act(() => {\r\n        result.current.deleteCache();\r\n      });\r\n\r\n      act(() => {\r\n        result.current.refetch();\r\n      });\r\n      await waitFor(\r\n        () => {\r\n          expect(result.current.loading).toBe(false);\r\n        },\r\n        { timeout: WAIT_MS },\r\n      );\r\n      expect(result.current.data).toBeDefined();\r\n    });\r\n  });\r\n\r\n  describe(\"binary response\", () => {\r\n    it(\"returns data and meta from worker\", async () => {\r\n      const cacheName = \"useApiWorker-binary-\" + Date.now();\r\n      const { result } = renderHook(() =>\r\n        useApiWorker({\r\n          cacheName,\r\n          request: {\r\n            url: \"https://httpbin.org/bytes/128\",\r\n            method: \"GET\",\r\n            responseType: \"binary\",\r\n          },\r\n          runMode: \"manual\",\r\n        }),\r\n      );\r\n\r\n      act(() => {\r\n        result.current.refetch();\r\n      });\r\n      await waitFor(\r\n        () => {\r\n          expect(result.current.loading).toBe(false);\r\n        },\r\n        { timeout: WAIT_MS },\r\n      );\r\n      expect(result.current.data).toBeDefined();\r\n      expect(Object.prototype.toString.call(result.current.data)).toBe(\"[object ArrayBuffer]\");\r\n      expect(result.current.meta).toBeDefined();\r\n    });\r\n  });\r\n});\r\n"]}