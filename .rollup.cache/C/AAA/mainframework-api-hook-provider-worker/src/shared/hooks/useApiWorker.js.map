{"version":3,"file":"useApiWorker.js","sourceRoot":"","sources":["useApiWorker.ts"],"names":[],"mappings":"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","sourcesContent":["// useApiWorker.ts\nimport { useRef, useState, useCallback, useEffect } from \"react\";\nimport { uniqueId } from \"../utils/uniqueId\";\nimport type {\n  DataRequest,\n  QueueEntry,\n  UseApiWorkerConfig,\n  UseApiWorkerReturn,\n  WorkerMessagePayload,\n} from \"../types/types\";\nimport { useCustomCallback } from \"./useCustomCallback\";\n\n// ============================================================================\n// MODULE-LEVEL WORKER & QUEUE\n// ============================================================================\n\nconst apiWorker = new Worker(new URL(\"../workers/api/api.worker\", import.meta.url));\n\nconst STALE_ENTRY_MS = 5000;\nconst CLEANUP_INTERVAL_MS = 30000;\n\nconst normalizeKey = (key: string) => key.toLowerCase();\n\nconst cleanupState = { isDeleting: false, lastRun: 0 };\n\nconst runStaleEntryCleanup = (): void => {\n  const now = Date.now();\n  if (cleanupState.isDeleting || now < cleanupState.lastRun + CLEANUP_INTERVAL_MS) return;\n  cleanupState.isDeleting = true;\n  try {\n    for (const key of Object.keys(responseQueue)) {\n      const entry = responseQueue[key];\n      if (!entry) continue;\n\n      if (entry.data != null && entry.lastActivityAt != null && now - entry.lastActivityAt >= STALE_ENTRY_MS) {\n        entry.loading = null;\n        entry.data = null;\n        entry.meta = null;\n        entry.error = null;\n        entry.setUpdateTrigger = null;\n        entry.requestId = null;\n      }\n    }\n  } finally {\n    cleanupState.isDeleting = false;\n    cleanupState.lastRun = now;\n  }\n};\n\nconst responseQueue: Record<string, QueueEntry<unknown>> = {};\n\nconst updater = (n: number) => n + 1;\n\nconst ERROR_KINDS = [\"http\", \"network\", \"validation\"] as const;\nconst isWorkerErrorPayload = (d: unknown): d is { kind: string; message: string; status?: number; code?: string } =>\n  !!d &&\n  typeof d === \"object\" &&\n  \"kind\" in d &&\n  typeof (d as { kind: unknown }).kind === \"string\" &&\n  ERROR_KINDS.includes((d as { kind: string }).kind as (typeof ERROR_KINDS)[number]) &&\n  \"message\" in d &&\n  typeof (d as { message: unknown }).message === \"string\";\n\n// Worker message handler\napiWorker.onmessage = (event: MessageEvent<WorkerMessagePayload>) => {\n  const { data, cacheName, meta } = event.data;\n  const errorPayload = isWorkerErrorPayload(event.data.data)\n    ? event.data.data\n    : event.data.error ?? (event.data.data && typeof event.data.data === \"object\" && \"error\" in event.data.data\n        ? (event.data.data as { error: unknown }).error\n        : null);\n\n  if (!cacheName) return;\n  const entry = responseQueue[normalizeKey(cacheName)];\n  if (!entry) return;\n  if (cacheName !== \"error\" && normalizeKey(entry.cacheName) !== normalizeKey(cacheName)) return;\n\n  if (errorPayload) {\n    const message =\n      typeof errorPayload === \"string\"\n        ? errorPayload\n        : typeof errorPayload === \"object\" &&\n            errorPayload !== null &&\n            \"message\" in errorPayload &&\n            typeof (errorPayload as { message: unknown }).message === \"string\"\n          ? (errorPayload as { message: string }).message\n          : \"Unknown error\";\n    entry.error = isWorkerErrorPayload(errorPayload)\n      ? {\n          kind: errorPayload.kind as \"http\" | \"network\" | \"validation\",\n          message,\n          ...(errorPayload.status !== undefined && { status: errorPayload.status }),\n          ...(errorPayload.code !== undefined && { code: errorPayload.code }),\n        }\n      : {\n          kind: \"validation\" as const,\n          message,\n          ...((event.data.data as { code?: string } | undefined)?.code !== undefined && {\n            code: (event.data.data as { code?: string }).code,\n          }),\n        };\n    entry.loading = false;\n  } else {\n    entry.data = data;\n    entry.meta = meta ?? null;\n    entry.lastActivityAt = Date.now();\n    entry.error = null;\n    entry.loading = false;\n  }\n  entry.requestId = null;\n  entry.setUpdateTrigger?.(updater);\n};\n\n// ============================================================================\n// HOOK\n// ============================================================================\n\nexport type { RequestConfig, UseApiWorkerConfig, UseApiWorkerReturn } from \"../types/types\";\n\nexport const useApiWorker = <T>(config: UseApiWorkerConfig): UseApiWorkerReturn<T> => {\n  const { cacheName, request: requestConfig, data: configData, runMode = \"auto\", enabled = true } = config;\n\n  const hookIdRef = useRef<string>(\"\");\n  const queueKey = normalizeKey(cacheName);\n\n  const hasExecutedRef = useRef(false);\n  const [, setUpdateTrigger] = useState(0);\n\n  let storeEntry = responseQueue[queueKey];\n\n  if (!storeEntry) {\n    const hookId = uniqueId();\n    responseQueue[queueKey] = {\n      hookId,\n      cacheName,\n      data: null,\n      loading: false,\n      error: null,\n      setUpdateTrigger: () => {},\n      requestId: null,\n      meta: null,\n      lastActivityAt: null,\n    };\n    storeEntry = responseQueue[queueKey];\n    hookIdRef.current = hookId;\n  } else {\n    hookIdRef.current = storeEntry.hookId;\n    storeEntry.lastActivityAt = Date.now();\n  }\n  storeEntry.setUpdateTrigger = setUpdateTrigger;\n\n  const hookId = hookIdRef.current;\n\n  const deleteCache = useCallback(() => {\n    if (cacheName) {\n      apiWorker.postMessage({\n        dataRequest: { type: \"delete\", cacheName, hookId },\n      });\n    }\n  }, [cacheName, hookId]);\n\n  useEffect(() => {\n    runStaleEntryCleanup();\n  });\n\n  const makeRequest = useCustomCallback(() => {\n    if (!enabled || (runMode === \"once\" && hasExecutedRef.current)) return;\n    const entry = responseQueue[queueKey];\n    if (!entry || entry.loading) return;\n    const requestId = uniqueId();\n    entry.requestId = requestId;\n    entry.loading = true;\n    entry.error = null;\n    entry.lastActivityAt = Date.now();\n    entry.setUpdateTrigger?.(updater);\n\n    const dataRequest: DataRequest<unknown> = requestConfig\n      ? {\n          type: \"set\",\n          cacheName,\n          hookId,\n          requestId,\n          payload: configData,\n          request: requestConfig,\n        }\n      : { type: \"get\", cacheName, hookId };\n\n    apiWorker.postMessage({ dataRequest });\n    hasExecutedRef.current = true;\n  }, [hookId, queueKey, cacheName, requestConfig, configData, runMode, enabled, setUpdateTrigger]);\n\n  const shouldRun = (runMode === \"auto\" || runMode === \"once\") && enabled && (requestConfig || cacheName);\n  if (shouldRun && !(runMode === \"once\" && hasExecutedRef.current) && !storeEntry.loading) {\n    const now = Date.now();\n    if (requestConfig) {\n      makeRequest();\n    } else {\n      storeEntry.loading = true;\n      storeEntry.error = null;\n      storeEntry.lastActivityAt = now;\n      if (runMode === \"once\") hasExecutedRef.current = true;\n      setUpdateTrigger(updater);\n      apiWorker.postMessage({ dataRequest: { type: \"get\", cacheName, hookId } as DataRequest<unknown> });\n    }\n  }\n\n  return {\n    data: (storeEntry?.data as T) ?? null,\n    meta: storeEntry?.meta ?? null,\n    loading: storeEntry?.loading ?? false,\n    error: storeEntry?.error ?? null,\n    refetch: makeRequest,\n    deleteCache,\n  };\n};\n"]}